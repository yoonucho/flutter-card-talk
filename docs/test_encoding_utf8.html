<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ì½”ë”©/ë””ì½”ë”© í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .section {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <h1>ì¸ì½”ë”©/ë””ì½”ë”© í…ŒìŠ¤íŠ¸</h1>
    
    <div class="container">
        <div class="section">
            <h2>ë¬¸ì œ URL í…ŒìŠ¤íŠ¸</h2>
            <textarea id="problemUrl" placeholder="í…ŒìŠ¤íŠ¸í•  URLì„ ì…ë ¥í•˜ì„¸ìš”">https://yoonucho.github.io/flutter-card-talk/view.html?id=f511e71a-6f66-4574-9163-f03cd0716848&data=eyJuYW1lIjoi7J2R7JuQIiwiZW1vamkiOiLwn5KqIiwibWVzc2FnZSI6IuuLueyLoOydgCDstqnrtoTtnogg7J6Y7ZWY6rOgIOyeiOyWtOyalCEg8J+SqiDtnpjrgrTshLjsmpRcblxu7ZmU7J207YyFISIsImJhY2tncm91bmRDb2xvciI6IiNlOGVhZjYiLCJ0ZXh0Q29sb3IiOiIjM2Y1MWI1In0=</textarea>
            <button onclick="testProblemUrl()">URL í…ŒìŠ¤íŠ¸</button>
            <div>
                <h3>ê²°ê³¼:</h3>
                <pre id="urlResult">ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</pre>
            </div>
        </div>

        <div class="section">
            <h2>JSON â†’ Base64 ì¸ì½”ë”©</h2>
            <textarea id="jsonInput" placeholder="JSON ë°ì´í„° ì…ë ¥">{"name":"ì‘ì›","emoji":"ğŸ’ª","message":"ë‹¹ì‹ ì€ ì¶©ë¶„íˆ ì˜í•˜ê³  ìˆì–´ìš”! ğŸ’ª í˜ë‚´ì„¸ìš”\n\ní™”ì´íŒ…!","backgroundColor":"#e8eaf6","textColor":"#3f51b5"}</textarea>
            <button onclick="encodeBase64()">ì¸ì½”ë”©</button>
            <div>
                <h3>Base64 ê²°ê³¼:</h3>
                <pre id="base64Result">ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</pre>
            </div>
        </div>

        <div class="section">
            <h2>Base64 â†’ JSON ë””ì½”ë”©</h2>
            <textarea id="base64Input" placeholder="Base64 ë°ì´í„° ì…ë ¥">eyJuYW1lIjoi7J2R7JuQIiwiZW1vamkiOiLwn5KqIiwibWVzc2FnZSI6IuuLueyLoOydgCDstqnrtoTtnogg7J6Y7ZWY6rOgIOyeiOyWtOyalCEg8J+SqiDtnpjrgrTshLjsmpRcblxu7ZmU7J207YyFISIsImJhY2tncm91bmRDb2xvciI6IiNlOGVhZjYiLCJ0ZXh0Q29sb3IiOiIjM2Y1MWI1In0=</textarea>
            <button onclick="decodeBase64()">ë””ì½”ë”©</button>
            <div>
                <h3>ë””ì½”ë”© ê²°ê³¼:</h3>
                <pre id="decodedResult">ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</pre>
            </div>
        </div>
    </div>

    <script>
        // UTF-8 ë¬¸ìì—´ì„ Base64ë¡œ ì¸ì½”ë”©í•˜ëŠ” í•¨ìˆ˜
        function utf8ToBase64(str) {
            try {
                const encoder = new TextEncoder();
                const utf8Bytes = encoder.encode(str);
                let binaryString = '';
                utf8Bytes.forEach(byte => {
                    binaryString += String.fromCharCode(byte);
                });
                return btoa(binaryString);
            } catch (e) {
                console.error("UTF-8 ì¸ì½”ë”© ì˜¤ë¥˜:", e);
                return null;
            }
        }

        // Base64ë¥¼ UTF-8 ë¬¸ìì—´ë¡œ ë””ì½”ë”©í•˜ëŠ” í•¨ìˆ˜
        function base64ToUtf8(base64) {
            try {
                // ë°©ë²• 1: TextDecoder ì‚¬ìš©
                try {
                    // Base64ë¥¼ ë°”ì´ë„ˆë¦¬ ë¬¸ìì—´ë¡œ ë””ì½”ë”©
                    const binaryString = atob(base64);
                    console.log("ë°”ì´ë„ˆë¦¬ ë¬¸ìì—´ ê¸¸ì´:", binaryString.length);
                    
                    // ë°”ì´ë„ˆë¦¬ ë¬¸ìì—´ì„ Uint8Arrayë¡œ ë³€í™˜
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    console.log("Uint8Array ìƒì„± ì™„ë£Œ:", bytes.length);
                    
                    // TextDecoderë¥¼ ì‚¬ìš©í•˜ì—¬ UTF-8ë¡œ ë””ì½”ë”©
                    const decoder = new TextDecoder('utf-8');
                    const result = decoder.decode(bytes);
                    console.log("TextDecoder ë””ì½”ë”© ê²°ê³¼:", result);
                    return result;
                } catch (textDecoderError) {
                    console.error("TextDecoder ì˜¤ë¥˜:", textDecoderError);
                    
                    // ë°©ë²• 2: ìˆ˜ë™ ë””ì½”ë”© ì‹œë„
                    try {
                        const binaryString = atob(base64);
                        let result = '';
                        let i = 0;
                        
                        while (i < binaryString.length) {
                            let c = binaryString.charCodeAt(i);
                            
                            if (c < 128) {
                                // ASCII ë¬¸ì
                                result += String.fromCharCode(c);
                                i++;
                            } else if (c > 191 && c < 224) {
                                // 2ë°”ì´íŠ¸ ë¬¸ì
                                const c2 = binaryString.charCodeAt(i + 1);
                                result += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
                                i += 2;
                            } else {
                                // 3ë°”ì´íŠ¸ ë¬¸ì
                                const c2 = binaryString.charCodeAt(i + 1);
                                const c3 = binaryString.charCodeAt(i + 2);
                                result += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                                i += 3;
                            }
                        }
                        
                        console.log("ìˆ˜ë™ ë””ì½”ë”© ê²°ê³¼:", result);
                        return result;
                    } catch (manualError) {
                        console.error("ìˆ˜ë™ ë””ì½”ë”© ì˜¤ë¥˜:", manualError);
                        throw manualError;
                    }
                }
            } catch (e) {
                console.error("Base64 ë””ì½”ë”© ì˜¤ë¥˜:", e);
                throw e;
            }
        }

        // URLì—ì„œ ë°ì´í„° ì¶”ì¶œ ë° í…ŒìŠ¤íŠ¸
        function testProblemUrl() {
            try {
                const urlString = document.getElementById("problemUrl").value;
                const url = new URL(urlString);
                const urlParams = new URLSearchParams(url.search);
                const encodedData = urlParams.get("data");
                
                if (!encodedData) {
                    document.getElementById("urlResult").innerHTML = "<span class='error'>URLì—ì„œ data íŒŒë¼ë¯¸í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>";
                    return;
                }

                document.getElementById("urlResult").innerHTML = 
                    `<strong>ì¸ì½”ë”©ëœ ë°ì´í„°:</strong> ${encodedData}\n\n` +
                    `<strong>URL ë””ì½”ë”©:</strong> ${decodeURIComponent(encodedData)}\n\n`;

                try {
                    // URL ë””ì½”ë”© ë¨¼ì € ìˆ˜í–‰
                    const urlDecoded = decodeURIComponent(encodedData);
                    
                    // URL ì•ˆì „ Base64ë¥¼ í‘œì¤€ Base64ë¡œ ë³€í™˜ (- â†’ +, _ â†’ /, íŒ¨ë”© ì¶”ê°€)
                    let base64Data = urlDecoded.replace(/-/g, "+").replace(/_/g, "/");
                    // íŒ¨ë”© ì¶”ê°€
                    while (base64Data.length % 4) {
                        base64Data += "=";
                    }
                    
                    // UTF-8 ì§€ì› Base64 ë””ì½”ë”©
                    const jsonData = base64ToUtf8(base64Data);
                    const cardData = JSON.parse(jsonData);
                    
                    document.getElementById("urlResult").innerHTML += 
                        `<strong>ë””ì½”ë”© ì„±ê³µ!</strong>\n` +
                        `<strong>JSON ë°ì´í„°:</strong>\n${JSON.stringify(cardData, null, 2)}`;
                } catch (error) {
                    document.getElementById("urlResult").innerHTML += 
                        `<span class='error'><strong>ë””ì½”ë”© ì˜¤ë¥˜:</strong> ${error.message}</span>`;
                }
            } catch (error) {
                document.getElementById("urlResult").innerHTML = 
                    `<span class='error'><strong>ì˜¤ë¥˜:</strong> ${error.message}</span>`;
            }
        }

        // JSON â†’ Base64 ì¸ì½”ë”©
        function encodeBase64() {
            const jsonData = document.getElementById("jsonInput").value;
            try {
                // JSON íŒŒì‹± í…ŒìŠ¤íŠ¸
                JSON.parse(jsonData);
                
                // UTF-8 Base64 ì¸ì½”ë”©
                const encoded = utf8ToBase64(jsonData);
                document.getElementById("base64Result").innerHTML = encoded;
                
                // URL ì•ˆì „ ì¸ì½”ë”©
                document.getElementById("base64Result").innerHTML += 
                    `\n\n<strong>URL ì•ˆì „ ì¸ì½”ë”©:</strong>\n${encodeURIComponent(encoded)}`;
                return encoded;
            } catch (e) {
                document.getElementById("base64Result").innerHTML = 
                    `<span class='error'><strong>ì˜¤ë¥˜:</strong> ${e.message}</span>`;
                return null;
            }
        }

        // Base64 â†’ JSON ë””ì½”ë”©
        function decodeBase64() {
            const base64Data = document.getElementById("base64Input").value;
            try {
                // URL ë””ì½”ë”© ì‹œë„
                let decodedData;
                try {
                    decodedData = decodeURIComponent(base64Data);
                    document.getElementById("decodedResult").innerHTML = 
                        `<strong>URL ë””ì½”ë”© ê²°ê³¼:</strong>\n${decodedData}\n\n`;
                } catch (e) {
                    document.getElementById("decodedResult").innerHTML = 
                        `<span class='error'><strong>URL ë””ì½”ë”© ì˜¤ë¥˜:</strong> ${e.message}</span>\n` +
                        `<strong>ì›ë³¸ ì‚¬ìš©:</strong>\n${base64Data}\n\n`;
                    decodedData = base64Data;
                }
                
                // Base64 ë””ì½”ë”©
                const jsonData = base64ToUtf8(decodedData);
                document.getElementById("decodedResult").innerHTML += 
                    `<strong>Base64 ë””ì½”ë”© ê²°ê³¼:</strong>\n${jsonData}\n\n`;
                
                // JSON íŒŒì‹±
                const parsedData = JSON.parse(jsonData);
                document.getElementById("decodedResult").innerHTML += 
                    `<strong>JSON íŒŒì‹± ì„±ê³µ!</strong>\n${JSON.stringify(parsedData, null, 2)}`;
            } catch (e) {
                document.getElementById("decodedResult").innerHTML += 
                    `<span class='error'><strong>ì˜¤ë¥˜:</strong> ${e.message}</span>`;
            }
        }
    </script>
</body>
</html>
